

# This file orchestrates the three services of the MERN stack: MongoDB, API, and React Frontend.
services:

  # 1. MongoDB Database Service
  mongo:
    image: mongo:latest
    container_name: cloudship_mongo_db
    restart: always
    # Expose the default MongoDB port for local connection tools (like Compass)
    ports:
      - "27017:27017"
    # Persist the data on your local machine so it survives container restarts
    volumes:
      - mongo-data:/data/db
    networks:
      - app-network

  # 2. Backend API Service (Node.js/Express/Mongoose)
  api:
    build: 
      context: ./server # Build using the Dockerfile located in the server subdirectory
      dockerfile: Dockerfile
    container_name: cloudship_api
    restart: always
    # Map the host's port 5000 to the container's internal port 5000
    ports:
      - "5000:5000"
    # Environment variables used by server/index.js (dotenv is reading the MONGO_URI from the ENV passed here)
    environment:
      # CRITICAL: The hostname must be the service name 'mongo' for internal Docker networking
      MONGO_URI: mongodb://mongo:27017/cloudshipdb
      PORT: 5000
    # The API should wait for the MongoDB container to start
    depends_on:
      - mongo
    # Mount the source code for hot reloading (Node.js --watch)
    volumes:
      - ./server:/app
      - /app/node_modules # Exclude node_modules to avoid issues
    networks:
      - app-network

  # 3. Frontend Application Service (Vite/React)
  frontend:
    build:
      context: . # Build using the Dockerfile in the root directory
      dockerfile: Dockerfile
    container_name: cloudship_frontend
    # Map the host's port 5173 to the container's internal port 5173 (Vite default)
    ports:
      - "5173:5173"
    # Environment variables to configure the Vite app
    environment:
      # Use the 'api' service name to route frontend requests to the backend
      VITE_API_BASE_URL: http://api:5000
      CHOKIDAR_USEPOLLING: true # Recommended for Vite/Watcher stability inside Docker
    # Mount the source code for instant hot module replacement (HMR)
    volumes:
      - .:/app
      - /app/node_modules # Exclude node_modules
    # The frontend should wait for the API to be available
    depends_on:
      - api
    networks:
      - app-network

# Define a named volume to ensure MongoDB data is persisted
volumes:
  mongo-data:

# Define a single network so all three containers can talk to each other
networks:
  app-network:
    driver: bridge